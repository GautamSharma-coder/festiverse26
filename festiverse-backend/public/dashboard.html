<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Festiverse'26</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg-dark: #050505; --accent: #ccff00; }
    body { font-family: 'Space Grotesk', sans-serif; background-color: var(--bg-dark); color: white; }
    h1, h2, h3, .font-display { font-family: 'Syne', sans-serif; }
    
    .texture-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.07'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 50;
    }

    .glass-panel { 
      background: #0f0f0f; 
      border: 1px solid rgba(255,255,255,0.1); 
    }

    .btn-lime { 
      background: var(--accent); 
      color: black; 
      font-weight: bold; 
      transition: all 0.3s; 
    }
    .btn-lime:hover { 
      background: white; 
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    }
    
    .qr-blur { filter: blur(4px); transition: 0.3s; }
    .qr-container:hover .qr-blur { filter: blur(0); }
    
    /* Loading State */
    .skeleton { background: rgba(255,255,255,0.1); color: transparent !important; border-radius: 4px; }
  </style>
</head>
<body class="antialiased min-h-screen">
<div class="texture-overlay"></div>

<nav class="fixed top-0 w-full z-40 px-6 py-6 flex justify-between items-center mix-blend-difference">
  <a href="index.html" class="font-display font-bold text-xl tracking-tighter text-white">
    FESTIVERSE<span class="text-[#ccff00]">.</span>
  </a>
  <div class="flex items-center gap-6">
    <span class="text-xs font-bold uppercase tracking-widest text-[#ccff00] hidden md:block">‚óè System Online</span>
    <button onclick="logout()" class="text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition">Disconnect</button>
  </div>
</nav>

<main class="pt-32 pb-20 px-6 max-w-7xl mx-auto relative z-10">

  <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6">
    <div>
      <p class="text-gray-500 text-xs font-bold uppercase tracking-widest mb-2">Cadet Profile</p>
      <h1 class="font-display text-4xl md:text-6xl font-bold text-white uppercase">
        Welcome, <span id="display-name" class="text-transparent bg-clip-text bg-gradient-to-r from-[#ccff00] to-white">Cadet</span>
      </h1>
    </div>
    <div class="text-right hidden md:block">
      <p id="top-college-id" class="text-2xl font-bold font-display">--</p>
      <p class="text-xs text-gray-500 uppercase tracking-widest">Universal ID</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <div class="space-y-8">
      
      <div class="glass-panel p-8 rounded-2xl relative overflow-hidden">
        <div class="absolute top-0 right-0 w-20 h-20 bg-[#ccff00]/10 rounded-full blur-2xl"></div>
        <div class="flex items-center gap-4 mb-6">
          <div class="w-16 h-16 rounded-full bg-[#1a1a1a] border border-white/20 flex items-center justify-center text-2xl">
            üë®‚ÄçüöÄ
          </div>
          <div>
            <h3 id="profile-name" class="font-bold text-white text-lg">--</h3>
            <p class="text-xs text-gray-500 uppercase tracking-widest">Authorized Personnel</p>
          </div>
        </div>
        
        <div class="space-y-3">
          <div class="flex justify-between text-sm border-b border-white/5 pb-2">
            <span class="text-gray-500">System ID</span>
            <span id="profile-id" class="text-white text-right">--</span>
          </div>
          <div class="flex justify-between text-sm border-b border-white/5 pb-2">
            <span class="text-gray-500">Email</span>
            <span id="profile-email" class="text-white text-right">--</span>
          </div>
          <div class="flex justify-between text-sm pt-2">
            <span class="text-gray-500">Pass Type</span>
            <span class="text-[#ccff00] font-bold uppercase">Cosmic Access</span>
          </div>
        </div>
      </div>

      <div class="glass-panel p-6 rounded-2xl">
        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Command Center</h4>
        <div class="grid grid-cols-2 gap-3">
          <button class="py-3 bg-[#1a1a1a] hover:bg-[#ccff00] hover:text-black border border-white/10 rounded-lg text-xs font-bold uppercase transition-all">
            Edit Profile
          </button>
          <a href="contact.html" class="block text-center py-3 bg-[#1a1a1a] hover:bg-[#ccff00] hover:text-black border border-white/10 rounded-lg text-xs font-bold uppercase transition-all">
            Support
          </a>
        </div>
      </div>

    </div>

    <div class="lg:col-span-2 space-y-8">
      
      <div class="glass-panel p-8 rounded-2xl border-l-4 border-[#ccff00] flex flex-col md:flex-row justify-between items-center gap-8 group qr-container cursor-pointer">
        <div class="flex-1">
          <div class="inline-block px-3 py-1 bg-[#ccff00] text-black text-[10px] font-bold uppercase tracking-widest rounded-full mb-4">
            Active Pass
          </div>
          <h2 class="font-display text-3xl font-bold text-white mb-2">ALL ACCESS ENTRY</h2>
          <p class="text-gray-500 text-sm">Valid for: Apr 08 - Apr 10, 2026</p>
          <p class="text-gray-500 text-xs mt-4">Show this QR code at the Grand Orion Arena gate.</p>
        </div>
        <div class="relative w-32 h-32 bg-white p-2 rounded-lg">
          <img id="qr-img" src="" alt="QR Code" class="w-full h-full qr-blur">
          <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-black uppercase tracking-widest bg-white/80 opacity-100 group-hover:opacity-0 transition-opacity">
            Hover to Reveal
          </div>
        </div>
      </div>

      <div>
        <h3 class="font-display text-2xl font-bold text-white mb-6">MY MISSIONS</h3>
        <div class="space-y-4">
          
            <div class="glass-panel p-6 rounded-xl hover:border-[#ccff00] transition-colors">
                <div class="flex justify-between items-start mb-4">
                <div>
                    <h4 class="text-xl font-bold text-white">Hackathon: CodeX</h4>
                    <p class="text-xs text-[#ccff00] uppercase tracking-widest mt-1">Team: Binary Bandits</p>
                </div>
                <span class="px-3 py-1 bg-green-900/30 text-green-400 border border-green-500/30 rounded text-[10px] font-bold uppercase">Confirmed</span>
                </div>
                
                <div class="bg-[#050505] p-4 rounded-lg border border-white/5">
                <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-3">Squad Members</p>
                <div class="flex flex-wrap gap-2">
                    <span class="px-3 py-1 bg-[#1a1a1a] text-gray-300 text-xs rounded border border-white/10" id="mission-leader">You (L)</span>
                    <span class="px-3 py-1 bg-[#1a1a1a] text-gray-300 text-xs rounded border border-white/10">Pending...</span>
                </div>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-xl border border-dashed border-white/10 flex items-center justify-center text-center">
                <div>
                    <p class="text-gray-500 text-sm mb-4">No other active missions detected.</p>
                    <a href="register.html" class="inline-block px-6 py-2 bg-[#1a1a1a] hover:bg-[#ccff00] hover:text-black border border-white/10 rounded-full text-xs font-bold uppercase transition-all">Register New Event</a>
                </div>
            </div>

        </div>
      </div>

    </div>

  </div>

</main>

<script>
  // --- AUTHENTICATION CHECK ---
  window.onload = function() {
    const token = localStorage.getItem('userToken');
    const userStr = localStorage.getItem('userData');

    // 1. Redirect if not logged in
    if (!token || !userStr) {
        window.location.href = 'auth.html';
        return;
    }

    // 2. Parse Data
    const user = JSON.parse(userStr);
    
    // 3. Update DOM Elements
    // Use first name for header
    const firstName = user.name.split(' ')[0];
    document.getElementById('display-name').innerText = firstName;
    
    // Profile details
    document.getElementById('profile-name').innerText = user.name;
    document.getElementById('profile-email').innerText = user.email;
    document.getElementById('profile-id').innerText = user.collegeId || "N/A";
    
    // Top right ID
    document.getElementById('top-college-id').innerText = user.collegeId || "PENDING";

    // 4. Generate Dynamic QR Code
    // We use the ID or Email to generate a unique QR for entry
    const qrData = `FESTIVERSE-ACCESS:${user.collegeId || user.email}`;
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;
    document.getElementById('qr-img').src = qrUrl;

    // 5. Update Mission Leader Name
    document.getElementById('mission-leader').innerText = `${firstName} (L)`;
  };

  // --- LOGOUT LOGIC ---
  function logout() {
    if(confirm("Terminate session and return to base?")) {
      localStorage.removeItem('userToken');
      localStorage.removeItem('userData');
      window.location.href = 'auth.html';
    }
  }
</script>

<footer class="py-10 border-t border-white/10 text-center relative z-10 bg-black">
  <p class="font-display text-xs tracking-widest text-gray-600 uppercase">
    Last Login: <span id="login-time">Today</span> // Festiverse'26
  </p>
</footer>
<script>
  // --- AUTHENTICATION CHECK & DATA LOADING ---
  window.onload = async function() {
    const token = localStorage.getItem('userToken');
    const userStr = localStorage.getItem('userData');

    // 1. Redirect if not logged in
    if (!token || !userStr) {
        window.location.href = 'auth.html';
        return;
    }

    const user = JSON.parse(userStr);
    
    // 2. Populate Profile UI
    const firstName = user.name.split(' ')[0];
    document.getElementById('display-name').innerText = firstName;
    document.getElementById('profile-name').innerText = user.name;
    document.getElementById('profile-email').innerText = user.email;
    document.getElementById('profile-id').innerText = user.collegeId || "N/A";
    document.getElementById('top-college-id').innerText = user.collegeId || "PENDING";

    // 3. Generate QR Code
    const qrData = `FESTIVERSE-ACCESS:${user.collegeId || user.email}`;
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;
    document.getElementById('qr-img').src = qrUrl;

    // 4. Fetch User's Real Registrations
    await loadMyMissions(token);
  };

  async function loadMyMissions(token) {
    const container = document.querySelector('.space-y-4'); // The container for mission cards
    // Keep the "MY MISSIONS" header, remove old static cards
    // Note: In your HTML, the container has the header outside the div with class 'space-y-4'? 
    // If 'space-y-4' is inside the 'My Missions' section, we clear it.
    // Let's target the specific div that holds the cards.
    
    // Finding the specific div inside the right column
    const missionsContainer = document.querySelectorAll('.lg\\:col-span-2 .space-y-4')[1]; 
    // (The first space-y-4 is usually the QR code wrapper or parent, checking structure...)
    // A safer way is to give the missions list an ID in HTML, but here is a dynamic approach:
    
    if(!missionsContainer) return; // Safety check
    
    try {
        const response = await fetch('/api/my-registrations', {
            method: 'GET',
            headers: { 
                'Authorization': token,
                'Content-Type': 'application/json' 
            }
        });

        const data = await response.json();

        if (data.success && data.registrations.length > 0) {
            missionsContainer.innerHTML = ''; // Clear static placeholders

            data.registrations.forEach(reg => {
                // Determine Status Color
                let statusColor = "bg-yellow-900/30 text-yellow-400 border-yellow-500/30"; // Default Registered
                if (reg.status === 'Confirmed' || reg.status === 'Checked In') statusColor = "bg-green-900/30 text-green-400 border-green-500/30";
                
                // Format Team Members if any
                let teamHtml = '';
                if(reg.teamMembers && reg.teamMembers.length > 0) {
                    const members = reg.teamMembers.map(m => 
                        `<span class="px-3 py-1 bg-[#1a1a1a] text-gray-300 text-xs rounded border border-white/10">${m}</span>`
                    ).join('');
                    
                    teamHtml = `
                    <div class="bg-[#050505] p-4 rounded-lg border border-white/5 mt-4">
                        <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-3">Squad Members</p>
                        <div class="flex flex-wrap gap-2">${members}</div>
                    </div>`;
                }

                const card = `
                <div class="glass-panel p-6 rounded-xl hover:border-[#ccff00] transition-colors fade-in">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-xl font-bold text-white">${reg.event}</h4>
                            <p class="text-xs text-gray-500 uppercase tracking-widest mt-1">ID: ${reg._id.slice(-6)}</p>
                            ${reg.teamName ? `<p class="text-xs text-[#ccff00] uppercase tracking-widest mt-1">Team: ${reg.teamName}</p>` : ''}
                        </div>
                        <span class="px-3 py-1 border rounded text-[10px] font-bold uppercase ${statusColor}">${reg.status}</span>
                    </div>
                    ${teamHtml}
                </div>`;
                
                missionsContainer.innerHTML += card;
            });
        } else {
            // No registrations found
            missionsContainer.innerHTML = `
            <div class="glass-panel p-6 rounded-xl border border-dashed border-white/10 flex items-center justify-center text-center">
                <div>
                    <p class="text-gray-500 text-sm mb-4">No active missions detected.</p>
                    <a href="register.html" class="inline-block px-6 py-2 bg-[#1a1a1a] hover:bg-[#ccff00] hover:text-black border border-white/10 rounded-full text-xs font-bold uppercase transition-all">Register New Event</a>
                </div>
            </div>`;
        }

    } catch (error) {
        console.error("Load Error", error);
    }
  }

  // --- LOGOUT LOGIC ---
  function logout() {
    if(confirm("Terminate session and return to base?")) {
      localStorage.removeItem('userToken');
      localStorage.removeItem('userData');
      window.location.href = 'auth.html';
    }
  }
</script>
</body>
</html>