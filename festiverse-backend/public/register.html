<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register | Festiverse'26</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg-dark: #050505; --accent: #ccff00; }
    body { font-family: 'Space Grotesk', sans-serif; background-color: var(--bg-dark); color: white; }
    h1, h2, h3, .font-display { font-family: 'Syne', sans-serif; }
    
    .texture-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.07'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 50;
    }

    .input-field { 
      background: #111; 
      border: 1px solid rgba(255,255,255,0.1); 
      transition: all 0.3s; 
      color: white; 
    }
    .input-field:focus { 
      border-color: var(--accent); 
      outline: none; 
      background: #161616; 
    }
    
    .btn-lime { 
      background: var(--accent); 
      color: black; 
      font-weight: bold; 
      transition: all 0.3s; 
    }
    .btn-lime:hover { 
      background: white; 
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    }

    /* Step Styles */
    .step-indicator { opacity: 0.3; transition: all 0.3s; }
    .step-indicator.active { opacity: 1; color: var(--accent); }
    
    .hidden-step { display: none; }
    .fade-in { animation: fadeIn 0.5s ease forwards; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="antialiased">
<div class="texture-overlay"></div>

<nav class="fixed top-0 w-full z-40 px-6 py-6 flex justify-between items-center mix-blend-difference">
  <a href="index.html" class="font-display font-bold text-xl tracking-tighter text-white">
    FESTIVERSE<span class="text-[#ccff00]">.</span>
  </a>
  <a href="index.html" class="text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition">‚Üê Back to Orbit</a>
</nav>

<main class="pt-32 pb-20 px-6 max-w-7xl mx-auto relative z-10">
  
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
    
    <div class="lg:col-span-2">
      <div class="flex items-center gap-4 mb-8">
        <div id="ind-1" class="step-indicator active font-display text-xl font-bold">01 PERSONAL INTEL</div>
        <div class="h-px bg-white/20 w-12"></div>
        <div id="ind-2" class="step-indicator font-display text-xl font-bold">02 EVENT PROTOCOL</div>
      </div>

      <div class="bg-[#0f0f0f] border border-white/10 rounded-2xl p-8 md:p-12 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-[#ccff00]/5 rounded-full blur-3xl pointer-events-none -translate-y-1/2 translate-x-1/2"></div>
        
        <form id="regForm" class="space-y-6">
          
          <div id="step-1" class="fade-in space-y-6">
            <h2 class="font-display text-2xl font-bold text-white mb-6">Cadet Identity</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-xs font-bold uppercase tracking-widest text-[#ccff00] mb-2">Full Name</label>
                <input type="text" id="name" placeholder="Loading..." class="input-field w-full px-6 py-4 rounded-lg bg-[#0a0a0a] text-gray-400 cursor-not-allowed" readonly>
              </div>
              <div>
                <label class="block text-xs font-bold uppercase tracking-widest text-[#ccff00] mb-2">College Name</label>
                <input type="text" id="college" placeholder="e.g. IIT Delhi" class="input-field w-full px-6 py-4 rounded-lg" required>
              </div>
              <div>
                <label class="block text-xs font-bold uppercase tracking-widest text-[#ccff00] mb-2">Email ID</label>
                 <input type="email" id="email" placeholder="Loading..." class="input-field w-full px-6 py-4 rounded-lg bg-[#0a0a0a] text-gray-400 cursor-not-allowed" readonly>
              </div>
              <div>
                <label class="block text-xs font-bold uppercase tracking-widest text-[#ccff00] mb-2">Phone</label>
                <input type="tel" id="phone" placeholder="+91 98765 43210" class="input-field w-full px-6 py-4 rounded-lg" required>
              </div>
              
              <input type="hidden" id="universityId">
            </div>
            <button type="button" onclick="nextStep()" class="w-full py-4 btn-lime rounded-lg font-bold font-display uppercase tracking-widest text-sm">
              Proceed to Event Selection ‚Üí
            </button>
          </div>

          <div id="step-2" class="hidden-step space-y-6">
            <h2 class="font-display text-2xl font-bold text-white mb-6">Mission Selection</h2>
            
            <div>
              <label class="block text-xs font-bold uppercase tracking-widest text-[#ccff00] mb-2">Select Event</label>
              <select id="eventSelect" onchange="handleEventChange()" class="input-field w-full px-6 py-4 rounded-lg text-gray-300">
                <option value="" disabled selected>-- Choose your protocol --</option>
                <option value="Solo Dance" data-team="1">Solo Dance (Solo)</option>
                <option value="Solo Singing" data-team="1">Solo Singing (Solo)</option>
                <option value="Sketching" data-team="1">Sketching (Solo)</option>
                
                <option value="Debate" data-team="2">Debate (2 Members)</option>
                <option value="Quiz" data-team="3">Quiz (Max 3 Members)</option>
                <option value="Group Dance" data-team="10">Group Dance (4-10 Members)</option>
                <option value="Drama" data-team="10">Drama (5-10 Members)</option>
                <option value="Face Painting" data-team="2">Face Painting (2 Members)</option>
                <option value="Rangoli" data-team="3">Rangoli (2-3 Members)</option>
              </select>
            </div>

            <div id="teamSection" class="hidden-step space-y-6 border-t border-white/10 pt-6">
              <div class="bg-white/5 p-4 rounded-lg border border-[#ccff00]/30">
                <p class="text-xs text-[#ccff00] font-bold uppercase tracking-widest mb-2">‚ö†Ô∏è Team Protocol Initiated</p>
                <p class="text-sm text-gray-400">This event requires a squad. You are the Team Leader (Member 1).</p>
              </div>

              <div>
                <label class="block text-xs font-bold uppercase tracking-widest text-[#ccff00] mb-2">Team Name</label>
                <input type="text" id="teamName" placeholder="Ex: The Avengers" class="input-field w-full px-6 py-4 rounded-lg">
              </div>

              <div id="membersContainer" class="space-y-4">
                </div>
            </div>

            <div class="flex gap-4">
              <button type="button" onclick="prevStep()" class="flex-1 py-4 border border-white/20 hover:bg-white/10 text-white rounded-lg font-bold font-display uppercase tracking-widest text-sm">
                ‚Üê Back
              </button>
              <button type="submit" class="flex-1 py-4 btn-lime rounded-lg font-bold font-display uppercase tracking-widest text-sm">
                Confirm Registration
              </button>
            </div>
          </div>

        </form>
      </div>
    </div>

    <div class="space-y-8">
      <div class="bg-[#111] border border-[#ccff00] rounded-2xl p-8 relative">
        <h3 class="text-xl font-bold text-white mb-4 font-display">Registration Guide</h3>
        <ul class="space-y-4 text-sm text-gray-400 list-disc pl-4 marker:text-[#ccff00]">
          <li>Ensure personal details match your College ID.</li>
          <li>For team events, only the <strong>Team Leader</strong> needs to register.</li>
          <li>Bring your unique Ticket ID to the "Grand Orion Arena" for entry.</li>
        </ul>
      </div>

      <div class="p-6 rounded-2xl bg-[#0f0f0f] border border-white/10 text-center">
         <p class="text-xs font-bold text-gray-500 uppercase tracking-widest">Need Help?</p>
         <p class="text-white mt-2 font-display">help@festiverse.com</p>
      </div>
    </div>

  </div>
</main>

<script>
  // --- AUTH CHECK & AUTOFILL ---
  window.onload = function() {
    const token = localStorage.getItem('userToken');
    const userStr = localStorage.getItem('userData');

    // 1. If not logged in, redirect to Auth
    if (!token || !userStr) {
        alert("üîí SYSTEM LOCKED: Authentication Required.\nRedirecting to Access Control...");
        window.location.href = 'auth.html';
        return;
    }

    // 2. Parse Data
    const user = JSON.parse(userStr);

    // 3. Auto-fill form fields
    if(user.name) document.getElementById('name').value = user.name;
    if(user.email) document.getElementById('email').value = user.email;
    if(user.collegeId) document.getElementById('universityId').value = user.collegeId;
  };

  // --- STATE MANAGEMENT ---
  let formData = {
    name: "",
    college: "",
    email: "",
    phone: "",
    universityId: ""
  };

  // --- STEP LOGIC ---
  function nextStep() {
    // 1. Capture Step 1 Values
    const name = document.getElementById('name').value.trim();
    const college = document.getElementById('college').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const universityId = document.getElementById('universityId').value.trim();

    // 2. Simple Validation
    if (!name || !college || !email || !phone) {
      alert("‚ö†Ô∏è Please complete all Personal Intel fields.");
      return;
    }

    // 3. Save to state
    formData = { name, college, email, phone, universityId };

    // 4. UI Transition
    document.getElementById('step-1').classList.add('hidden-step');
    document.getElementById('step-1').classList.remove('fade-in');
    
    const step2 = document.getElementById('step-2');
    step2.classList.remove('hidden-step');
    step2.classList.add('fade-in');

    document.getElementById('ind-1').classList.remove('active');
    document.getElementById('ind-2').classList.add('active');
  }

  function prevStep() {
    document.getElementById('step-2').classList.add('hidden-step');
    document.getElementById('step-2').classList.remove('fade-in');

    const step1 = document.getElementById('step-1');
    step1.classList.remove('hidden-step');
    step1.classList.add('fade-in');

    document.getElementById('ind-2').classList.remove('active');
    document.getElementById('ind-1').classList.add('active');
  }

  // --- DYNAMIC EVENT LOGIC ---
  function handleEventChange() {
    const select = document.getElementById('eventSelect');
    const teamSection = document.getElementById('teamSection');
    const membersContainer = document.getElementById('membersContainer');

    // Get team size from selected option data attribute
    const selectedOption = select.options[select.selectedIndex];
    const maxMembers = parseInt(selectedOption.getAttribute('data-team') || 1);

    membersContainer.innerHTML = ''; // Clear previous inputs

    if (maxMembers > 1) {
      teamSection.classList.remove('hidden-step');
      
      // Generate inputs for Member 2 to Max (Member 1 is the leader/user)
      for (let i = 2; i <= maxMembers; i++) {
        const div = document.createElement('div');
        div.className = "fade-in"; // Add animation
        div.innerHTML = `
          <label class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-2">Member ${i} Name</label>
          <input type="text" class="team-member-input input-field w-full px-6 py-4 rounded-lg text-sm" placeholder="Cadet Name" required>
        `;
        membersContainer.appendChild(div);
      }
    } else {
      teamSection.classList.add('hidden-step');
    }
  }

  // --- BACKEND CONNECTION (SUBMISSION) ---
  document.getElementById('regForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerText;
    btn.innerText = "Transmitting...";
    btn.disabled = true;

    // 1. Gather Step 2 Data
    const event = document.getElementById('eventSelect').value;
    const teamName = document.getElementById('teamName').value.trim();
    
    // 2. Gather Team Members
    const teamMembers = [];
    // Always add the leader (User) as the first member
    teamMembers.push(formData.name);
    
    // Add other members if they exist
    const memberInputs = document.querySelectorAll('.team-member-input');
    memberInputs.forEach(input => {
        if(input.value.trim()) teamMembers.push(input.value.trim());
    });

    // 3. Construct Payload
    const payload = {
        ...formData,       // Spread step 1 data (name, college, etc)
        event,             // Event Name
        teamName,          // Team Name (optional for solo)
        teamMembers        // Array of names
    };

    try {
        const token = localStorage.getItem('userToken');
        
        // 4. Send to Backend
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': token 
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success) {
            alert(`‚úÖ MISSION CONFIRMED!\nTicket ID: ${result.ticketId}`);
            window.location.href = 'dashboard.html'; // Redirect to Dashboard to see the new card
        } else {
            alert(`‚ùå ERROR: ${result.message}`);
        }

    } catch (error) {
        console.error('Submission Error:', error);
        alert("‚ùå CRITICAL FAILURE: Unable to contact server.");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
  });
</script>

<footer class="py-10 border-t border-white/10 text-center relative z-10 bg-black">
  <p class="font-display text-xs tracking-widest text-gray-600 uppercase">
    System Status: Online // Step 2 of 2
  </p>
</footer>
</body>
</html>