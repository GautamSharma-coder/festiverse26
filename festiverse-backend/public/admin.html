<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control | Festiverse Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #818cf8; }
        body { font-family: 'Inter', sans-serif; background: #020617; }
        .font-title { font-family: 'Syncopate', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .hidden { display: none !important; }
        /* Action Buttons */
        .btn-icon { cursor: pointer; transition: transform 0.2s; }
        .btn-icon:hover { transform: scale(1.2); }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div id="login-overlay" class="fixed inset-0 z-50 bg-[#020617] flex justify-center items-center">
        <div class="glass p-10 rounded-2xl text-center max-w-sm w-full mx-4">
            <h2 class="font-title text-2xl font-bold text-white mb-6">SECURITY CHECK</h2>
            <input type="password" id="admin-pass" placeholder="Enter Access Code" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white mb-4 focus:border-indigo-500 focus:outline-none">
            <button onclick="checkAuth()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition-all">UNLOCK SYSTEM</button>
            <p id="error-msg" class="text-red-500 text-xs mt-4 hidden">Access Denied</p>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen pb-20">
        <nav class="border-b border-white/10 bg-[#020617]/80 backdrop-blur-md sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                    <h1 class="font-title text-xl font-bold text-white">MISSION CONTROL</h1>
                </div>
                <button onclick="logout()" class="text-xs font-bold text-red-400 uppercase tracking-widest">Terminate Session</button>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 py-10">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <div class="glass p-6 rounded-2xl border-l-4 border-indigo-500">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Registrations</p>
                    <h3 id="total-reg" class="text-4xl font-title font-bold text-white mt-2">0</h3>
                </div>
                <div class="glass p-6 rounded-2xl border-l-4 border-fuchsia-500">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Revenue (Est.)</p>
                    <h3 id="total-rev" class="text-4xl font-title font-bold text-white mt-2">‚Çπ0</h3>
                </div>
                <div class="glass p-6 rounded-2xl border-l-4 border-emerald-500">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Messages</p>
                    <h3 id="total-msg" class="text-4xl font-title font-bold text-white mt-2">0</h3>
                </div>
            </div>

            <div class="flex gap-4 mb-6 border-b border-white/10 pb-4">
                <button onclick="switchTab('registrations')" id="tab-reg" class="text-white font-bold border-b-2 border-indigo-500 pb-1">Registrations</button>
                <button onclick="switchTab('messages')" id="tab-msg" class="text-slate-500 font-bold hover:text-white pb-1">Messages</button>
            </div>

            <div id="view-registrations" class="glass rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-slate-400">
                        <thead class="bg-white/5 text-xs uppercase font-bold text-white">
                            <tr>
                                <th class="px-6 py-4">Name</th>
                                <th class="px-6 py-4">ID</th>
                                <th class="px-6 py-4">Interest</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reg-table-body" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-messages" class="hidden glass rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-slate-400">
                        <thead class="bg-white/5 text-xs uppercase font-bold text-white">
                            <tr>
                                <th class="px-6 py-4">Date</th>
                                <th class="px-6 py-4">Sender</th>
                                <th class="px-6 py-4">Message</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="msg-table-body" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
    // --- AUTHENTICATION ---
    
    // Check if we already have a token when page loads
    window.onload = () => {
        if(localStorage.getItem('adminToken')) {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadData();
        }
    };

    async function checkAuth() {
        const password = document.getElementById('admin-pass').value;
        const errorMsg = document.getElementById('error-msg');

        try {
            const res = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });

            const data = await res.json();

            if (data.success) {
                // SAVE TOKEN TO BROWSER
                localStorage.setItem('adminToken', data.token);
                
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadData();
            } else {
                errorMsg.innerText = "Access Denied: Invalid Credentials";
                errorMsg.classList.remove('hidden');
            }
        } catch (err) {
            errorMsg.innerText = "Server Connection Failed";
            errorMsg.classList.remove('hidden');
        }
    }

    function logout() {
        localStorage.removeItem('adminToken');
        location.reload();
    }

    // --- HELPER: FETCH WITH TOKEN ---
    async function authFetch(url, options = {}) {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            logout();
            return;
        }

        // Add Authorization Header
        const headers = { ...options.headers, 'Authorization': token };
        const response = await fetch(url, { ...options, headers });

        if (response.status === 401 || response.status === 403) {
            logout(); // Token expired or invalid
            return null;
        }
        return response;
    }

    // --- DATA LOADING ---
    async function loadData() {
        try {
            const regRes = await authFetch('/api/admin/registrations');
            const registrations = await regRes.json();
            
            const msgRes = await authFetch('/api/admin/messages');
            const messages = await msgRes.json();
            
            renderRegistrations(registrations);
            renderMessages(messages);
            
            document.getElementById('total-reg').innerText = registrations.length;
            document.getElementById('total-rev').innerText = "‚Çπ" + (registrations.length * 500).toLocaleString();
            document.getElementById('total-msg').innerText = messages.length;
        } catch (err) { 
            console.error(err);
        }
    }

    // --- ACTIONS (CRUD) ---
    async function deleteItem(type, id) {
        if(!confirm("Are you sure you want to delete this?")) return;
        
        const endpoint = type === 'reg' ? `/api/admin/registrations/${id}` : `/api/admin/messages/${id}`;
        const res = await authFetch(endpoint, { method: 'DELETE' });
        
        if(res && res.ok) loadData();
    }

    async function toggleStatus(id, currentStatus) {
        const newStatus = currentStatus === 'Registered' ? 'Checked In' : 'Registered';
        
        const res = await authFetch(`/api/admin/registrations/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });

        if(res && res.ok) loadData();
    }

    // --- RENDERING (Same as before) ---
    function renderRegistrations(data) {
        const tbody = document.getElementById('reg-table-body');
        tbody.innerHTML = '';
        data.forEach(reg => {
            const statusColor = reg.status === 'Checked In' ? 'text-emerald-400' : 'text-slate-400';
            tbody.innerHTML += `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 font-bold text-white">${reg.name}</td>
                    <td class="px-6 py-4">${reg.universityId}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold bg-indigo-500/20 text-indigo-300">${reg.interest}</span></td>
                    <td class="px-6 py-4 ${statusColor} font-bold">${reg.status || 'Registered'}</td>
                    <td class="px-6 py-4 text-right space-x-4">
                        <button onclick="toggleStatus('${reg._id}', '${reg.status || 'Registered'}')" class="btn-icon text-xl" title="Toggle Status">‚úÖ</button>
                        <button onclick="deleteItem('reg', '${reg._id}')" class="btn-icon text-xl" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>`;
        });
    }

    function renderMessages(data) {
        const tbody = document.getElementById('msg-table-body');
        tbody.innerHTML = '';
        data.forEach(msg => {
            tbody.innerHTML += `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 text-xs font-mono">${msg.date}</td>
                    <td class="px-6 py-4 font-bold text-white">${msg.name} <br><span class="text-xs text-slate-500 font-normal">${msg.email}</span></td>
                    <td class="px-6 py-4 italic text-slate-300">"${msg.message}"</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="deleteItem('msg', '${msg.id}')" class="btn-icon text-xl" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>`;
        });
    }

    // --- TABS (Same as before) ---
    function switchTab(tab) {
        const regView = document.getElementById('view-registrations');
        const msgView = document.getElementById('view-messages');
        const regTab = document.getElementById('tab-reg');
        const msgTab = document.getElementById('tab-msg');

        if(tab === 'registrations') {
            regView.classList.remove('hidden'); msgView.classList.add('hidden');
            regTab.className = 'text-white font-bold border-b-2 border-indigo-500 pb-1';
            msgTab.className = 'text-slate-500 font-bold hover:text-white pb-1';
        } else {
            regView.classList.add('hidden'); msgView.classList.remove('hidden');
            msgTab.className = 'text-white font-bold border-b-2 border-indigo-500 pb-1';
            regTab.className = 'text-slate-500 font-bold hover:text-white pb-1';
        }
    }
</script>
</body>
</html>